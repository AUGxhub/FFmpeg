%include "libavutil/x86/x86util.asm"

SECTION_RODATA

INIT_XMM sse2
SECTION .text

cglobal imm4_idct, 1, 1, 0, block
    movq    mm0, [blockq]
    movq    mm1, [blockq+8]
    movq    mm2, mm0
    movq    mm3, word_10142098
    punpcklwd mm0, mm1
    movq    mm5, mm0
    punpckldq mm0, mm0
    movq    mm4, word_101420A0
    punpckhwd mm2, mm1
    pmaddwd mm3, mm0
    movq    mm6, mm2
    movq    mm1, word_101420B8
    punpckldq mm2, mm2
    pmaddwd mm4, mm2
    punpckhdq mm5, mm5
    pmaddwd mm0, word_101420A8
    punpckhdq mm6, mm6
    movq    mm7, qword_101420C0
    pmaddwd mm1, mm5
    paddd   mm3, qword_10142058
    pmaddwd mm7, mm6
    pmaddwd mm2, word_101420B0
    paddd   mm3, mm4
    pmaddwd mm5, qword_101420C8
    movq    mm4, mm3
    pmaddwd mm6, qword_101420D0
    paddd   mm1, mm7
    paddd   mm0, qword_10142058
    psubd   mm3, mm1
    psrad   mm3, 0Bh
    paddd   mm1, mm4
    paddd   mm0, mm2
    psrad   mm1, 0Bh
    paddd   mm5, mm6
    movq    mm4, mm0
    paddd   mm0, mm5
    psubd   mm4, mm5
    psrad   mm0, 0Bh
    psrad   mm4, 0Bh
    packssdw mm1, mm0
    packssdw mm4, mm3
    movq    mm7, mm4
    psrld   mm4, 10h
    pslld   mm7, 10h
    movq    [blockq], mm1
    por     mm7, mm4
    movq    [blockq+8], mm7
    movq    mm0, [blockq+10h]
    movq    mm1, [blockq+18h]
    movq    mm2, mm0
    movq    mm3, qword_101420D8
    punpcklwd mm0, mm1
    movq    mm5, mm0
    punpckldq mm0, mm0
    movq    mm4, qword_101420E0
    punpckhwd mm2, mm1
    pmaddwd mm3, mm0
    movq    mm6, mm2
    movq    mm1, qword_101420F8
    punpckldq mm2, mm2
    pmaddwd mm4, mm2
    punpckhdq mm5, mm5
    pmaddwd mm0, qword_101420E8
    punpckhdq mm6, mm6
    movq    mm7, qword_10142100
    pmaddwd mm1, mm5
    paddd   mm3, qword_10142068
    pmaddwd mm7, mm6
    pmaddwd mm2, qword_101420F0
    paddd   mm3, mm4
    pmaddwd mm5, qword_10142108
    movq    mm4, mm3
    pmaddwd mm6, qword_10142110
    paddd   mm1, mm7
    paddd   mm0, qword_10142068
    psubd   mm3, mm1
    psrad   mm3, 0Bh
    paddd   mm1, mm4
    paddd   mm0, mm2
    psrad   mm1, 0Bh
    paddd   mm5, mm6
    movq    mm4, mm0
    paddd   mm0, mm5
    psubd   mm4, mm5
    psrad   mm0, 0Bh
    psrad   mm4, 0Bh
    packssdw mm1, mm0
    packssdw mm4, mm3
    movq    mm7, mm4
    psrld   mm4, 10h
    pslld   mm7, 10h
    movq    [blockq+10h], mm1
    por     mm7, mm4
    movq    [blockq+18h], mm7
    movq    mm0, [blockq+20h]
    movq    mm1, [blockq+28h]
    movq    mm2, mm0
    movq    mm3, qword_10142118
    punpcklwd mm0, mm1
    movq    mm5, mm0
    punpckldq mm0, mm0
    movq    mm4, qword_10142120
    punpckhwd mm2, mm1
    pmaddwd mm3, mm0
    movq    mm6, mm2
    movq    mm1, qword_10142138
    punpckldq mm2, mm2
    pmaddwd mm4, mm2
    punpckhdq mm5, mm5
    pmaddwd mm0, qword_10142128
    punpckhdq mm6, mm6
    movq    mm7, qword_10142140
    pmaddwd mm1, mm5
    paddd   mm3, qword_10142078
    pmaddwd mm7, mm6
    pmaddwd mm2, qword_10142130
    paddd   mm3, mm4
    pmaddwd mm5, qword_10142148
    movq    mm4, mm3
    pmaddwd mm6, qword_10142150
    paddd   mm1, mm7
    paddd   mm0, qword_10142078
    psubd   mm3, mm1
    psrad   mm3, 0Bh
    paddd   mm1, mm4
    paddd   mm0, mm2
    psrad   mm1, 0Bh
    paddd   mm5, mm6
    movq    mm4, mm0
    paddd   mm0, mm5
    psubd   mm4, mm5
    psrad   mm0, 0Bh
    psrad   mm4, 0Bh
    packssdw mm1, mm0
    packssdw mm4, mm3
    movq    mm7, mm4
    psrld   mm4, 10h
    pslld   mm7, 10h
    movq    [blockq+20h], mm1
    por     mm7, mm4
    movq    [blockq+28h], mm7
    movq    mm0, [blockq+30h]
    movq    mm1, [blockq+38h]
    movq    mm2, mm0
    movq    mm3, qword_10142158
    punpcklwd mm0, mm1
    movq    mm5, mm0
    punpckldq mm0, mm0
    movq    mm4, qword_10142160
    punpckhwd mm2, mm1
    pmaddwd mm3, mm0
    movq    mm6, mm2
    movq    mm1, qword_10142178
    punpckldq mm2, mm2
    pmaddwd mm4, mm2
    punpckhdq mm5, mm5
    pmaddwd mm0, qword_10142168
    punpckhdq mm6, mm6
    movq    mm7, qword_10142180
    pmaddwd mm1, mm5
    paddd   mm3, qword_10142088
    pmaddwd mm7, mm6
    pmaddwd mm2, qword_10142170
    paddd   mm3, mm4
    pmaddwd mm5, qword_10142188
    movq    mm4, mm3
    pmaddwd mm6, qword_10142190
    paddd   mm1, mm7
    paddd   mm0, qword_10142088
    psubd   mm3, mm1
    psrad   mm3, 0Bh
    paddd   mm1, mm4
    paddd   mm0, mm2
    psrad   mm1, 0Bh
    paddd   mm5, mm6
    movq    mm4, mm0
    paddd   mm0, mm5
    psubd   mm4, mm5
    psrad   mm0, 0Bh
    psrad   mm4, 0Bh
    packssdw mm1, mm0
    packssdw mm4, mm3
    movq    mm7, mm4
    psrld   mm4, 10h
    pslld   mm7, 10h
    movq    [blockq+30h], mm1
    por     mm7, mm4
    movq    [blockq+38h], mm7
    movq    mm0, [blockq+40h]
    movq    mm1, [blockq+48h]
    movq    mm2, mm0
    movq    mm3, word_10142098
    punpcklwd mm0, mm1
    movq    mm5, mm0
    punpckldq mm0, mm0
    movq    mm4, word_101420A0
    punpckhwd mm2, mm1
    pmaddwd mm3, mm0
    movq    mm6, mm2
    movq    mm1, word_101420B8
    punpckldq mm2, mm2
    pmaddwd mm4, mm2
    punpckhdq mm5, mm5
    pmaddwd mm0, word_101420A8
    punpckhdq mm6, mm6
    movq    mm7, qword_101420C0
    pmaddwd mm1, mm5
    paddd   mm3, qword_10142060
    pmaddwd mm7, mm6
    pmaddwd mm2, word_101420B0
    paddd   mm3, mm4
    pmaddwd mm5, qword_101420C8
    movq    mm4, mm3
    pmaddwd mm6, qword_101420D0
    paddd   mm1, mm7
    paddd   mm0, qword_10142060
    psubd   mm3, mm1
    psrad   mm3, 0Bh
    paddd   mm1, mm4
    paddd   mm0, mm2
    psrad   mm1, 0Bh
    paddd   mm5, mm6
    movq    mm4, mm0
    paddd   mm0, mm5
    psubd   mm4, mm5
    psrad   mm0, 0Bh
    psrad   mm4, 0Bh
    packssdw mm1, mm0
    packssdw mm4, mm3
    movq    mm7, mm4
    psrld   mm4, 10h
    pslld   mm7, 10h
    movq    [blockq+40h], mm1
    por     mm7, mm4
    movq    [blockq+48h], mm7
    movq    mm0, [blockq+50h]
    movq    mm1, [blockq+58h]
    movq    mm2, mm0
    movq    mm3, qword_10142158
    punpcklwd mm0, mm1
    movq    mm5, mm0
    punpckldq mm0, mm0
    movq    mm4, qword_10142160
    punpckhwd mm2, mm1
    pmaddwd mm3, mm0
    movq    mm6, mm2
    movq    mm1, qword_10142178
    punpckldq mm2, mm2
    pmaddwd mm4, mm2
    punpckhdq mm5, mm5
    pmaddwd mm0, qword_10142168
    punpckhdq mm6, mm6
    movq    mm7, qword_10142180
    pmaddwd mm1, mm5
    paddd   mm3, qword_10142090
    pmaddwd mm7, mm6
    pmaddwd mm2, qword_10142170
    paddd   mm3, mm4
    pmaddwd mm5, qword_10142188
    movq    mm4, mm3
    pmaddwd mm6, qword_10142190
    paddd   mm1, mm7
    paddd   mm0, qword_10142090
    psubd   mm3, mm1
    psrad   mm3, 0Bh
    paddd   mm1, mm4
    paddd   mm0, mm2
    psrad   mm1, 0Bh
    paddd   mm5, mm6
    movq    mm4, mm0
    paddd   mm0, mm5
    psubd   mm4, mm5
    psrad   mm0, 0Bh
    psrad   mm4, 0Bh
    packssdw mm1, mm0
    packssdw mm4, mm3
    movq    mm7, mm4
    psrld   mm4, 10h
    pslld   mm7, 10h
    movq    [blockq+50h], mm1
    por     mm7, mm4
    movq    [blockq+58h], mm7
    movq    mm0, [blockq+60h]
    movq    mm1, [blockq+68h]
    movq    mm2, mm0
    movq    mm3, qword_10142118
    punpcklwd mm0, mm1
    movq    mm5, mm0
    punpckldq mm0, mm0
    movq    mm4, qword_10142120
    punpckhwd mm2, mm1
    pmaddwd mm3, mm0
    movq    mm6, mm2
    movq    mm1, qword_10142138
    punpckldq mm2, mm2
    pmaddwd mm4, mm2
    punpckhdq mm5, mm5
    pmaddwd mm0, qword_10142128
    punpckhdq mm6, mm6
    movq    mm7, qword_10142140
    pmaddwd mm1, mm5
    paddd   mm3, qword_10142080
    pmaddwd mm7, mm6
    pmaddwd mm2, qword_10142130
    paddd   mm3, mm4
    pmaddwd mm5, qword_10142148
    movq    mm4, mm3
    pmaddwd mm6, qword_10142150
    paddd   mm1, mm7
    paddd   mm0, qword_10142080
    psubd   mm3, mm1
    psrad   mm3, 0Bh
    paddd   mm1, mm4
    paddd   mm0, mm2
    psrad   mm1, 0Bh
    paddd   mm5, mm6
    movq    mm4, mm0
    paddd   mm0, mm5
    psubd   mm4, mm5
    psrad   mm0, 0Bh
    psrad   mm4, 0Bh
    packssdw mm1, mm0
    packssdw mm4, mm3
    movq    mm7, mm4
    psrld   mm4, 10h
    pslld   mm7, 10h
    movq    [blockq+60h], mm1
    por     mm7, mm4
    movq    [blockq+68h], mm7
    movq    mm0, [blockq+70h]
    movq    mm1, [blockq+78h]
    movq    mm2, mm0
    movq    mm3, qword_101420D8
    punpcklwd mm0, mm1
    movq    mm5, mm0
    punpckldq mm0, mm0
    movq    mm4, qword_101420E0
    punpckhwd mm2, mm1
    pmaddwd mm3, mm0
    movq    mm6, mm2
    movq    mm1, qword_101420F8
    punpckldq mm2, mm2
    pmaddwd mm4, mm2
    punpckhdq mm5, mm5
    pmaddwd mm0, qword_101420E8
    punpckhdq mm6, mm6
    movq    mm7, qword_10142100
    pmaddwd mm1, mm5
    paddd   mm3, qword_10142070
    pmaddwd mm7, mm6
    pmaddwd mm2, qword_101420F0
    paddd   mm3, mm4
    pmaddwd mm5, qword_10142108
    movq    mm4, mm3
    pmaddwd mm6, qword_10142110
    paddd   mm1, mm7
    paddd   mm0, qword_10142070
    psubd   mm3, mm1
    psrad   mm3, 0Bh
    paddd   mm1, mm4
    paddd   mm0, mm2
    psrad   mm1, 0Bh
    paddd   mm5, mm6
    movq    mm4, mm0
    paddd   mm0, mm5
    psubd   mm4, mm5
    psrad   mm0, 0Bh
    psrad   mm4, 0Bh
    packssdw mm1, mm0
    packssdw mm4, mm3
    movq    mm7, mm4
    psrld   mm4, 10h
    pslld   mm7, 10h
    movq    [blockq+70h], mm1
    por     mm7, mm4
    movq    [blockq+78h], mm7
    movq    mm0, qword_10142038
    movq    mm3, [blockq+30h]
    movq    mm1, mm0
    movq    mm5, [blockq+50h]
    pmulhw  mm0, mm3
    movq    mm4, qword_10142028
    pmulhw  mm1, mm5
    movq    mm7, [blockq+70h]
    movq    mm2, mm4
    movq    mm6, [blockq+10h]
    pmulhw  mm4, mm7
    paddsw  mm0, mm3
    pmulhw  mm2, mm6
    paddsw  mm1, mm3
    psubsw  mm0, mm5
    movq    mm3, word_10142048
    paddsw  mm1, mm5
    paddsw  mm4, mm6
    psubsw  mm2, mm7
    movq    mm5, mm4
    movq    mm6, mm2
    paddsw  mm5, mm1
    psubsw  mm6, mm0
    psubsw  mm4, mm1
    paddsw  mm2, mm0
    movq    mm7, qword_10142030
    movq    mm1, mm4
    movq    [blockq+30h], mm5
    paddsw  mm1, mm2
    movq    [blockq+50h], mm6
    psubsw  mm4, mm2
    movq    mm5, [blockq+20h]
    movq    mm0, mm7
    movq    mm6, [blockq+60h]
    pmulhw  mm0, mm5
    pmulhw  mm7, mm6
    pmulhw  mm1, mm3
    movq    mm2, [blockq]
    pmulhw  mm4, mm3
    psubsw  mm0, mm6
    movq    mm3, mm2
    movq    mm6, [blockq+40h]
    paddsw  mm7, mm5
    paddsw  mm2, mm6
    psubsw  mm3, mm6
    movq    mm5, mm2
    movq    mm6, mm3
    psubsw  mm2, mm7
    paddsw  mm3, mm0
    paddsw  mm1, mm1
    paddsw  mm4, mm4
    paddsw  mm5, mm7
    psubsw  mm6, mm0
    movq    mm7, mm3
    movq    mm0, mm6
    paddsw  mm3, mm1
    paddsw  mm6, mm4
    psraw   mm3, 6
    psubsw  mm7, mm1
    psraw   mm6, 6
    psubsw  mm0, mm4
    movq    mm1, [blockq+30h]
    psraw   mm7, 6
    movq    mm4, mm5
    psraw   mm0, 6
    movq    [blockq+10h], mm3
    paddsw  mm5, mm1
    movq    [blockq+20h], mm6
    psubsw  mm4, mm1
    movq    mm3, [blockq+50h]
    psraw   mm5, 6
    movq    mm6, mm2
    psraw   mm4, 6
    movq    [blockq+50h], mm0
    paddsw  mm2, mm3
    movq    [blockq+60h], mm7
    psubsw  mm6, mm3
    movq    [blockq], mm5
    psraw   mm2, 6
    movq    [blockq+70h], mm4
    psraw   mm6, 6
    movq    [blockq+30h], mm2
    movq    [blockq+40h], mm6
    movq    mm0, qword_10142038
    movq    mm3, [blockq+38h]
    movq    mm1, mm0
    movq    mm5, [blockq+58h]
    pmulhw  mm0, mm3
    movq    mm4, qword_10142028
    pmulhw  mm1, mm5
    movq    mm7, [blockq+78h]
    movq    mm2, mm4
    movq    mm6, [blockq+18h]
    pmulhw  mm4, mm7
    paddsw  mm0, mm3
    pmulhw  mm2, mm6
    paddsw  mm1, mm3
    psubsw  mm0, mm5
    movq    mm3, word_10142048
    paddsw  mm1, mm5
    paddsw  mm4, mm6
    psubsw  mm2, mm7
    movq    mm5, mm4
    movq    mm6, mm2
    paddsw  mm5, mm1
    psubsw  mm6, mm0
    psubsw  mm4, mm1
    paddsw  mm2, mm0
    movq    mm7, qword_10142030
    movq    mm1, mm4
    movq    [blockq+38h], mm5
    paddsw  mm1, mm2
    movq    [blockq+58h], mm6
    psubsw  mm4, mm2
    movq    mm5, [blockq+28h]
    movq    mm0, mm7
    movq    mm6, [blockq+68h]
    pmulhw  mm0, mm5
    pmulhw  mm7, mm6
    pmulhw  mm1, mm3
    movq    mm2, [blockq+8]
    pmulhw  mm4, mm3
    psubsw  mm0, mm6
    movq    mm3, mm2
    movq    mm6, [blockq+48h]
    paddsw  mm7, mm5
    paddsw  mm2, mm6
    psubsw  mm3, mm6
    movq    mm5, mm2
    movq    mm6, mm3
    psubsw  mm2, mm7
    paddsw  mm3, mm0
    paddsw  mm1, mm1
    paddsw  mm4, mm4
    paddsw  mm5, mm7
    psubsw  mm6, mm0
    movq    mm7, mm3
    movq    mm0, mm6
    paddsw  mm3, mm1
    paddsw  mm6, mm4
    psraw   mm3, 6
    psubsw  mm7, mm1
    psraw   mm6, 6
    psubsw  mm0, mm4
    movq    mm1, [blockq+38h]
    psraw   mm7, 6
    movq    mm4, mm5
    psraw   mm0, 6
    movq    [blockq+18h], mm3
    paddsw  mm5, mm1
    movq    [blockq+28h], mm6
    psubsw  mm4, mm1
    movq    mm3, [blockq+58h]
    psraw   mm5, 6
    movq    mm6, mm2
    psraw   mm4, 6
    movq    [blockq+58h], mm0
    paddsw  mm2, mm3
    movq    [blockq+68h], mm7
    psubsw  mm6, mm3
    movq    [blockq+8], mm5
    psraw   mm2, 6
    movq    [blockq+78h], mm4
    psraw   mm6, 6
    movq    [blockq+38h], mm2
    movq    [blockq+48h], mm6

    RET
